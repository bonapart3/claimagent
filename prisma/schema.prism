// ClaimAgent™ Database Schema
// Enterprise-grade P&C Insurance Claims Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          UserRole @default(ADJUSTER)
  carrierCode   String   // Organization identifier
  isActive      Boolean  @default(true)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  claims        Claim[]
  auditLogs     AuditLog[]
  sessions      Session[]

  @@index([email])
  @@index([carrierCode])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

enum UserRole {
  ADMIN
  SUPERVISOR
  ADJUSTER
  SIU_SPECIALIST
  APPRAISER
  VIEWER
}

// ============================================================================
// CLAIMS CORE
// ============================================================================

model Claim {
  id                String       @id @default(cuid())
  claimNumber       String       @unique
  status            ClaimStatus  @default(SUBMITTED)
  type              ClaimType
  severity          Int          @default(1) // 1-10 scale
  
  // Policy Information
  policyNumber      String
  policyEffectiveDate DateTime
  policyExpirationDate DateTime
  namedInsured      String
  
  // Loss Details
  lossDate          DateTime
  lossTime          String?
  lossLocation      String
  lossDescription   String       @db.Text
  lossState         String       // Two-letter state code
  
  // Vehicle Information
  vehicleYear       Int?
  vehicleMake       String?
  vehicleModel      String?
  vehicleVin        String?
  vehicleMileage    Int?
  
  // Financial
  estimatedAmount   Decimal      @db.Decimal(12, 2)
  reserveAmount     Decimal?     @db.Decimal(12, 2)
  paidAmount        Decimal      @default(0) @db.Decimal(12, 2)
  deductible        Decimal      @default(0) @db.Decimal(12, 2)
  
  // Coverage Details
  coverageType      CoverageType
  limits            Json         // Store limits as JSON
  
  // Fraud & Risk
  fraudScore        Int          @default(0) // 0-100
  fraudFlags        Json?        // Array of fraud indicators
  riskLevel         RiskLevel    @default(LOW)
  
  // Automated Decision
  autoApprovalEligible Boolean   @default(false)
  autoApprovalConfidence Decimal? @db.Decimal(5, 2) // Percentage
  routingDecision   String?      // AUTO_APPROVE, HUMAN_REVIEW, SIU, etc.
  
  // Assignment
  assignedTo        String?
  assignedAt        DateTime?
  
  // Timestamps
  submittedAt       DateTime     @default(now())
  acknowledgedAt    DateTime?
  closedAt          DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relationships
  assignedUser      User?        @relation(fields: [assignedTo], references: [id])
  documents         Document[]
  notes             ClaimNote[]
  activities        ClaimActivity[]
  payments          Payment[]
  fraudAnalysis     FraudAnalysis?
  valuation         Valuation?
  aiAssessments     AIAssessment[]
  escalations       Escalation[]

  @@index([claimNumber])
  @@index([status])
  @@index([policyNumber])
  @@index([lossDate])
  @@index([assignedTo])
  @@index([fraudScore])
  @@index([lossState])
  @@map("claims")
}

enum ClaimStatus {
  SUBMITTED
  ACKNOWLEDGED
  UNDER_INVESTIGATION
  PENDING_INFO
  EVALUATED
  APPROVED
  PAYMENT_ISSUED
  CLOSED
  DENIED
  WITHDRAWN
  REOPENED
}

enum ClaimType {
  COLLISION
  COMPREHENSIVE
  LIABILITY
  UNINSURED_MOTORIST
  UNDERINSURED_MOTORIST
  MEDICAL_PAYMENTS
  PIP
  TOTAL_LOSS
}

enum CoverageType {
  COLLISION
  COMPREHENSIVE
  LIABILITY_BI
  LIABILITY_PD
  UM_BI
  UM_PD
  UIM_BI
  UIM_PD
  MEDICAL_PAYMENTS
  PIP
  RENTAL
  TOWING
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// DOCUMENTS & EVIDENCE
// ============================================================================

model Document {
  id            String       @id @default(cuid())
  claimId       String
  fileName      String
  fileType      String       // MIME type
  fileSize      Int          // Bytes
  fileUrl       String       // S3/storage URL
  documentType  DocumentType
  description   String?
  uploadedBy    String?
  
  // OCR/Analysis Results
  ocrText       String?      @db.Text
  extractedData Json?        // Structured data from document
  aiAnalysis    Json?        // AI analysis results
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([documentType])
  @@map("documents")
}

enum DocumentType {
  PHOTO_DAMAGE
  PHOTO_VIN
  PHOTO_ODOMETER
  ESTIMATE_REPAIR
  ESTIMATE_APPRAISAL
  POLICE_REPORT
  MEDICAL_BILL
  MEDICAL_RECORD
  INVOICE
  CORRESPONDENCE
  SETTLEMENT_AGREEMENT
  RELEASE_FORM
  OTHER
}

// ============================================================================
// NOTES & ACTIVITIES
// ============================================================================

model ClaimNote {
  id          String   @id @default(cuid())
  claimId     String
  userId      String
  noteText    String   @db.Text
  noteType    NoteType @default(GENERAL)
  isInternal  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@map("claim_notes")
}

enum NoteType {
  GENERAL
  CONTACT
  INVESTIGATION
  EVALUATION
  SETTLEMENT
  DENIAL
  ESCALATION
  SYSTEM_GENERATED
}

model ClaimActivity {
  id              String       @id @default(cuid())
  claimId         String
  activityType    ActivityType
  performedBy     String?      // User ID or "SYSTEM"
  description     String       @db.Text
  metadata        Json?        // Additional context
  timestamp       DateTime     @default(now())

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([timestamp])
  @@map("claim_activities")
}

enum ActivityType {
  CLAIM_SUBMITTED
  CLAIM_ACKNOWLEDGED
  DOCUMENT_UPLOADED
  STATUS_CHANGED
  ASSIGNED
  REASSIGNED
  NOTE_ADDED
  PAYMENT_INITIATED
  PAYMENT_COMPLETED
  ESCALATED
  FRAUD_FLAG_RAISED
  AI_ASSESSMENT_COMPLETED
  HUMAN_REVIEW_REQUESTED
  APPROVED
  DENIED
  CLOSED
  REOPENED
}

// ============================================================================
// FRAUD DETECTION
// ============================================================================

model FraudAnalysis {
  id                    String   @id @default(cuid())
  claimId               String   @unique
  overallScore          Int      // 0-100
  confidenceLevel       Decimal  @db.Decimal(5, 2)
  
  // Individual Risk Factors
  repeatedClaimantScore Int      @default(0)
  overlappingLossScore  Int      @default(0)
  inconsistencyScore    Int      @default(0)
  billingAnomalyScore   Int      @default(0)
  stagingIndicatorScore Int      @default(0)
  
  // Flags & Alerts
  redFlags              Json     // Array of specific red flags
  watchlistMatches      Json?    // Matched entities from watchlists
  
  // SIU Recommendation
  siuRecommendation     String?  @db.Text
  requiresSIUReview     Boolean  @default(false)
  
  analyzedAt            DateTime @default(now())
  analyzedBy            String   @default("SYSTEM")

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([overallScore])
  @@index([requiresSIUReview])
  @@map("fraud_analyses")
}

// ============================================================================
// VALUATION & SETTLEMENT
// ============================================================================

model Valuation {
  id                String   @id @default(cuid())
  claimId           String   @unique
  
  // Vehicle Values
  actualCashValue   Decimal? @db.Decimal(12, 2)
  salvageValue      Decimal? @db.Decimal(12, 2)
  repairEstimate    Decimal? @db.Decimal(12, 2)
  
  // Total Loss Determination
  isTotalLoss       Boolean  @default(false)
  totalLossFormula  String?  // State-specific formula used
  totalLossThreshold Decimal? @db.Decimal(5, 2) // Percentage
  
  // Source APIs
  acvSource         String?  // API provider
  salvageSource     String?
  
  // Calculations
  settlementAmount  Decimal? @db.Decimal(12, 2)
  calculationDetails Json?   // Detailed breakdown
  
  valuatedAt        DateTime @default(now())
  valuatedBy        String   @default("SYSTEM")

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@map("valuations")
}

// ============================================================================
// AI ASSESSMENTS
// ============================================================================

model AIAssessment {
  id                  String   @id @default(cuid())
  claimId             String
  assessmentType      AIAssessmentType
  
  // Damage Analysis
  damageEstimate      Decimal? @db.Decimal(12, 2)
  damageSeverity      Int?     // 1-10 scale
  repairability       String?  // REPAIRABLE, TOTAL_LOSS, UNCERTAIN
  
  // Image Analysis
  imageAnalysis       Json?    // Detailed damage breakdown
  confidence          Decimal? @db.Decimal(5, 2)
  
  // Model Information
  modelVersion        String
  processingTimeMs    Int?
  
  createdAt           DateTime @default(now())

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([assessmentType])
  @@map("ai_assessments")
}

enum AIAssessmentType {
  DAMAGE_ESTIMATION
  FRAUD_DETECTION
  SEVERITY_SCORING
  REPAIR_COST_PREDICTION
  TOTAL_LOSS_PREDICTION
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id              String        @id @default(cuid())
  claimId         String
  paymentType     PaymentType
  amount          Decimal       @db.Decimal(12, 2)
  payeeName       String
  payeeType       PayeeType
  
  // Payment Method
  method          PaymentMethod @default(CHECK)
  
  // Status Tracking
  status          PaymentStatus @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  issuedAt        DateTime?
  clearedAt       DateTime?
  
  // Reference Numbers
  checkNumber     String?
  transactionId   String?
  
  memo            String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([status])
  @@map("payments")
}

enum PaymentType {
  REPAIR_REIMBURSEMENT
  TOTAL_LOSS_SETTLEMENT
  MEDICAL_EXPENSE
  RENTAL_CAR
  TOWING
  STORAGE
  DEDUCTIBLE_WAIVER
  DIMINISHED_VALUE
  OTHER
}

enum PayeeType {
  INSURED
  REPAIR_SHOP
  MEDICAL_PROVIDER
  RENTAL_COMPANY
  TOW_COMPANY
  LIENHOLDER
  THIRD_PARTY
}

enum PaymentMethod {
  CHECK
  ACH
  WIRE
  DEBIT_CARD
  DIGITAL_WALLET
}

enum PaymentStatus {
  PENDING
  APPROVED
  ISSUED
  CLEARED
  CANCELLED
  RETURNED
}

// ============================================================================
// ESCALATIONS
// ============================================================================

model Escalation {
  id              String           @id @default(cuid())
  claimId         String
  escalationType  EscalationType
  reason          String           @db.Text
  priority        Int              @default(1) // 1-5 scale
  
  escalatedTo     String?          // User ID or department
  escalatedBy     String           @default("SYSTEM")
  
  status          EscalationStatus @default(OPEN)
  resolution      String?          @db.Text
  resolvedBy      String?
  resolvedAt      DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([status])
  @@index([escalationType])
  @@map("escalations")
}

enum EscalationType {
  FRAUD_SUSPECTED
  COVERAGE_DISPUTE
  BAD_FAITH_RISK
  LITIGATION
  REGULATORY_INQUIRY
  HIGH_SEVERITY
  COMPLEX_LIABILITY
  POLICY_INTERPRETATION
  SYSTEM_ERROR
  MISSING_INFORMATION
  SENSOR_ZONE_REPAIR
  TOTAL_LOSS_REVIEW
  PAYMENT_THRESHOLD_EXCEEDED
}

enum EscalationStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  CLOSED
}

// ============================================================================
// AUDIT & COMPLIANCE
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  entityType  String   // Claim, Payment, User, etc.
  entityId    String?
  changes     Json?    // Before/after values
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([timestamp])
  @@map("audit_logs")
}

// ============================================================================
// SYSTEM CONFIGURATION
// ============================================================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedBy   String?
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model StateRegulation {
  id                    String   @id @default(cuid())
  stateCode             String   @unique
  stateName             String
  
  // Total Loss Thresholds
  totalLossThreshold    Decimal  @db.Decimal(5, 2) // Percentage
  totalLossFormula      String   // Formula description
  
  // Regulatory Requirements
  acknowledgmentDays    Int      // Days to acknowledge claim
  investigationDays     Int      // Days to complete investigation
  paymentDays           Int      // Days to issue payment
  
  // Specific Rules
  requiresPoliceReport  Boolean  @default(false)
  diminishedValueAllowed Boolean @default(true)
  
  regulations           Json?    // Additional state-specific rules
  
  updatedAt             DateTime @updatedAt

  @@map("state_regulations")
}

// ============================================================================
// ANALYTICS & REPORTING
// ============================================================================

model ClaimMetric {
  id                String   @id @default(cuid())
  date              DateTime @db.Date
  carrierCode       String
  
  // Volume Metrics
  claimsSubmitted   Int      @default(0)
  claimsClosed      Int      @default(0)
  claimsPending     Int      @default(0)
  
  // Processing Metrics
  avgCycleTimeHours Decimal? @db.Decimal(8, 2)
  autoApprovalRate  Decimal? @db.Decimal(5, 2)
  escalationRate    Decimal? @db.Decimal(5, 2)
  
  // Financial Metrics
  totalPaid         Decimal  @default(0) @db.Decimal(14, 2)
  avgClaimAmount    Decimal? @db.Decimal(12, 2)
  
  // Quality Metrics
  fraudDetectionRate Decimal? @db.Decimal(5, 2)
  errorRate         Decimal? @db.Decimal(5, 2)
  
  createdAt         DateTime @default(now())

  @@unique([date, carrierCode])
  @@index([date])
  @@map("claim_metrics")
}/ ClaimAgent™ Database Schema
// PostgreSQL + Prisma ORM
// Multi-tenant, audit-ready, 50-state compliance

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "metrics"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model Carrier {
  id                    String    @id @default(cuid())
  name                  String
  code                  String    @unique
  annualWrittenPremium  Decimal   @db.Decimal(15, 2)
  licenseNumber         String
  domiciledState        String    @db.VarChar(2)
  isActive              Boolean   @default(true)
  tier                  CarrierTier @default(REGIONAL)
  
  // Relationships
  policies              Policy[]
  claims                Claim[]
  users                 User[]
  fraudRules            FraudRule[]
  handbooks             Handbook[]
  
  // Metadata
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([code])
  @@index([isActive])
}

enum CarrierTier {
  SMALL      // $5M-$50M
  REGIONAL   // $50M-$150M
  MIDSIZE    // $150M-$500M
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  firstName         String
  lastName          String
  role              UserRole
  carrierId         String
  carrier           Carrier   @relation(fields: [carrierId], references: [id])
  
  // Permissions
  canAutoApprove    Boolean   @default(false)
  approvalLimit     Decimal?  @db.Decimal(10, 2)
  
  // Activity
  lastLoginAt       DateTime?
  loginCount        Int       @default(0)
  isActive          Boolean   @default(true)
  
  // Relationships
  claims            Claim[]   @relation("AdjusterClaims")
  auditLogs         AuditLog[]
  sessions          Session[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([email])
  @@index([carrierId, role])
}

enum UserRole {
  ADMIN
  ADJUSTER
  SIU_SPECIALIST
  SUPERVISOR
  UNDERWRITER
  AGENT
  CUSTOMER
}

model Session {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String   @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  @@index([token])
  @@index([userId])
}

// ============================================
// POLICY MANAGEMENT
// ============================================

model Policy {
  id                String    @id @default(cuid())
  policyNumber      String    @unique
  carrierId         String
  carrier           Carrier   @relation(fields: [carrierId], references: [id])
  
  // Policyholder
  holderFirstName   String
  holderLastName    String
  holderEmail       String?
  holderPhone       String?
  holderAddress     Json      // {street, city, state, zip}
  
  // Coverage Period
  effectiveDate     DateTime
  expirationDate    DateTime
  status            PolicyStatus @default(ACTIVE)
  
  // Coverage Details
  coverages         Coverage[]
  vehicles          Vehicle[]
  
  // Premium
  annualPremium     Decimal   @db.Decimal(10, 2)
  
  // Relationships
  claims            Claim[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([policyNumber])
  @@index([carrierId])
  @@index([status])
  @@index([effectiveDate, expirationDate])
}

enum PolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

model Coverage {
  id                String    @id @default(cuid())
  policyId          String
  policy            Policy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  
  type              CoverageType
  limitPerPerson    Decimal?  @db.Decimal(10, 2)
  limitPerAccident  Decimal?  @db.Decimal(10, 2)
  limitProperty     Decimal?  @db.Decimal(10, 2)
  deductible        Decimal?  @db.Decimal(10, 2)
  
  // Special Limits
  uninsuredMotorist Boolean   @default(false)
  underinsuredMotorist Boolean @default(false)
  medicalPayments   Decimal?  @db.Decimal(10, 2)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([policyId, type])
}

enum CoverageType {
  LIABILITY
  COLLISION
  COMPREHENSIVE
  UM_UIM           // Uninsured/Underinsured Motorist
  MEDICAL_PAYMENTS
  RENTAL_REIMBURSEMENT
  ROADSIDE_ASSISTANCE
}

model Vehicle {
  id                String    @id @default(cuid())
  policyId          String
  policy            Policy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  
  vin               String    @unique
  year              Int
  make              String
  model             String
  trim              String?
  color             String?
  mileage           Int?
  
  // Valuation
  msrp              Decimal?  @db.Decimal(10, 2)
  currentACV        Decimal?  @db.Decimal(10, 2)
  lastValuationDate DateTime?
  
  // Features
  hasSensors        Boolean   @default(false)
  hasADAS           Boolean   @default(false) // Advanced Driver Assistance
  fuelType          String?
  
  // Relationships
  claims            Claim[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([vin])
  @@index([policyId])
}

// ============================================
// CLAIM MANAGEMENT (CORE)
// ============================================

model Claim {
  id                String    @id @default(cuid())
  claimNumber       String    @unique
  
  // References
  carrierId         String
  carrier           Carrier   @relation(fields: [carrierId], references: [id])
  policyId          String
  policy            Policy    @relation(fields: [policyId], references: [id])
  vehicleId         String?
  vehicle           Vehicle?  @relation(fields: [vehicleId], references: [id])
  adjusterId        String?
  adjuster          User?     @relation("AdjusterClaims", fields: [adjusterId], references: [id])
  
  // Incident Details
  lossDate          DateTime
  reportedDate      DateTime  @default(now())
  lossLocation      Json      // {address, city, state, zip, coordinates}
  lossDescription   String    @db.Text
  
  // Classification
  claimType         ClaimType
  lossType          LossType
  severity          SeveritySeverity        Severity
  complexity        Complexity
  
  // Status
  status            ClaimStatus @default(INTAKE)
  subStatus         String?
  
  // Financial
  estimatedLoss     Decimal?  @db.Decimal(10, 2)
  reserveAmount     Decimal?  @db.Decimal(10, 2)
  paidAmount        Decimal   @default(0) @db.Decimal(10, 2)
  deductible        Decimal?  @db.Decimal(10, 2)
  
  // Flags
  isTotalLoss       Boolean   @default(false)
  isFraudulent      Boolean   @default(false)
  fraudScore        Int       @default(0)
  requiresHumanReview Boolean @default(false)
  autoApprovalEligible Boolean @default(false)
  
  // Routing
  routingDecision   RoutingDecision?
  escalationReason  String?   @db.Text
  
  // Timestamps
  acknowledgedAt    DateTime?
  investigatedAt    DateTime?
  evaluatedAt       DateTime?
  settledAt         DateTime?
  closedAt          DateTime?
  
  // Relationships
  participants      ClaimParticipant[]
  documents         Document[]
  communications    Communication[]
  fraudAnalysis     FraudAnalysis?
  valuation         Valuation?
  settlement        Settlement?
  agentLogs         AgentLog[]
  auditLogs         AuditLog[]
  
  // Metadata
  metadata          Json?     // Flexible field for carrier-specific data
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([claimNumber])
  @@index([carrierId])
  @@index([policyId])
  @@index([status])
  @@index([lossDate])
  @@index([fraudScore])
  @@index([requiresHumanReview])
}

enum ClaimType {
  AUTO_LIABILITY
  AUTO_COLLISION
  AUTO_COMPREHENSIVE
  AUTO_UNINSURED_MOTORIST
  AUTO_PIP            // Personal Injury Protection
  AUTO_MEDICAL_PAYMENTS
}

enum LossType {
  COLLISION
  THEFT
  VANDALISM
  WEATHER
  FIRE
  GLASS
  HIT_AND_RUN
  ANIMAL
  OTHER
}

enum Severity {
  LOW           // PD only, < $2,500
  MEDIUM        // PD $2,500-$10,000
  HIGH          // PD > $10,000 or minor BI
  CRITICAL      // Serious BI, fatalities, litigation
}

enum Complexity {
  SIMPLE        // Single vehicle, clear liability
  MODERATE      // Multi-vehicle, shared liability
  COMPLEX       // Serious injury, legal involvement
}

enum ClaimStatus {
  INTAKE
  INVESTIGATION
  EVALUATION
  PENDING_APPROVAL
  APPROVED
  PAYMENT_PROCESSING
  CLOSED
  DENIED
  SUSPENDED
}

enum RoutingDecision {
  AUTO_APPROVED
  HUMAN_REVIEW
  SIU_ESCALATION
  SPECIALIST_REVIEW
  LEGAL_REVIEW
  DRAFT_DENIAL
}

// ============================================
// CLAIM PARTICIPANTS
// ============================================

model ClaimParticipant {
  id                String    @id @default(cuid())
  claimId           String
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  role              ParticipantRole
  
  // Personal Info
  firstName         String
  lastName          String
  email             String?
  phone             String?
  address           Json?
  
  // Driver Info (if applicable)
  licenseNumber     String?
  licenseState      String?   @db.VarChar(2)
  
  // Vehicle Info (if not insured vehicle)
  vehicleInfo       Json?     // {vin, year, make, model, plate}
  
  // Insurance Info (third party)
  insuranceCarrier  String?
  insurancePolicyNumber String?
  
  // Injury Info
  injuryDescription String?   @db.Text
  medicalTreatment  Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([claimId, role])
}

enum ParticipantRole {
  INSURED
  CLAIMANT
  WITNESS
  OTHER_DRIVER
  PASSENGER
  PEDESTRIAN
  ATTORNEY
  MEDICAL_PROVIDER
}

// ============================================
// DOCUMENTS & EVIDENCE
// ============================================

model Document {
  id                String    @id @default(cuid())
  claimId           String
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  type              DocumentType
  fileName          String
  fileSize          Int
  mimeType          String
  storageUrl        String    // S3/Cloud Storage URL
  
  // OCR/Extraction
  extractedText     String?   @db.Text
  extractedData     Json?     // Structured data from IDP
  ocrConfidence     Float?
  
  // AI Analysis (for photos)
  aiAnalysis        Json?     // Damage detection results
  damageAreas       String[]  // Array of detected damage locations
  estimatedCost     Decimal?  @db.Decimal(10, 2)
  
  // Metadata
  uploadedBy        String?
  uploadedAt        DateTime  @default(now())
  verifiedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([claimId, type])
}

enum DocumentType {
  PHOTO_VEHICLE
  PHOTO_SCENE
  POLICE_REPORT
  MEDICAL_RECORD
  REPAIR_ESTIMATE
  INVOICE
  RECEIPT
  CORRESPONDENCE
  LEGAL_DOCUMENT
  OTHER
}

// ============================================
// COMMUNICATIONS
// ============================================

model Communication {
  id                String    @id @default(cuid())
  claimId           String
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  type              CommunicationType
  direction         Direction
  
  // Recipient Info
  recipientEmail    String?
  recipientPhone    String?
  recipientName     String?
  
  // Content
  subject           String?
  body              String    @db.Text
  template          String?   // Template ID used
  
  // Delivery
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  status            CommStatus @default(DRAFT)
  
  // Compliance
  stateRequirements Json?     // State-specific disclosures included
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([claimId, type])
}

enum CommunicationType {
  ACKNOWLEDGMENT
  INFO_REQUEST
  STATUS_UPDATE
  APPROVAL_LETTER
  DENIAL_LETTER
  RESERVATION_OF_RIGHTS
  SETTLEMENT_OFFER
  PAYMENT_NOTICE
  INTERNAL_NOTE
}

enum Direction {
  OUTBOUND
  INBOUND
}

enum CommStatus {
  DRAFT
  PENDING_APPROVAL
  SENT
  DELIVERED
  FAILED
}

// ============================================
// FRAUD DETECTION
// ============================================

model FraudAnalysis {
  id                String    @id @default(cuid())
  claimId           String    @unique
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  overallScore      Int       @default(0) // 0-100
  riskLevel         RiskLevel @default(LOW)
  
  // Pattern Flags
  repeatedClaimant  Boolean   @default(false)
  overlappingLoss   Boolean   @default(false)
  stagingIndicators Boolean   @default(false)
  inconsistentStory Boolean   @default(false)
  
  // Medical Flags
  medicalFraudFlags Json?
  billingAnomalies  Boolean   @default(false)
  
  // Behavioral Flags
  rapidReporting    Boolean   @default(false)
  excessiveClaims   Boolean   @default(false)
  
  // Analysis Details
  flaggedReasons    String[]
  siuRecommendation String?   @db.Text
  
  // SIU Review
  siuReviewed       Boolean   @default(false)
  siuReviewedAt     DateTime?
  siuNotes          String?   @db.Text
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([overallScore])
  @@index([riskLevel])
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model FraudRule {
  id                String    @id @default(cuid())
  carrierId         String
  carrier           Carrier   @relation(fields: [carrierId], references: [id])
  
  name              String
  description       String    @db.Text
  ruleLogic         Json      // Condition/action structure
  scoreImpact       Int
  isActive          Boolean   @default(true)
  
  // Stats
  triggeredCount    Int       @default(0)
  truePositiveRate  Float?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([carrierId, isActive])
}

// ============================================
// VALUATION & SETTLEMENT
// ============================================

model Valuation {
  id                String    @id @default(cuid())
  claimId           String    @unique
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  // Vehicle Value
  preAccidentValue  Decimal   @db.Decimal(10, 2)
  postAccidentValue Decimal?  @db.Decimal(10, 2)
  diminishedValue   Decimal?  @db.Decimal(10, 2)
  
  // Total Loss
  isTotalLoss       Boolean   @default(false)
  totalLossThreshold Float?   // State-specific percentage
  salvageValue      Decimal?  @db.Decimal(10, 2)
  
  // Repair Costs
  estimatedRepairCost Decimal? @db.Decimal(10, 2)
  actualRepairCost  Decimal?  @db.Decimal(10, 2)
  laborCost         Decimal?  @db.Decimal(10, 2)
  partsCost         Decimal?  @db.Decimal(10, 2)
  
  // API Sources
  valuationSource   String?   // NADA, KBB, CCC, etc.
  apiResponse       Json?
  
  // Comparables
  comparables       Json?     // Similar vehicles sold recently
  
  valuedAt          DateTime  @default(now())
  valuedBy          String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Settlement {
  id                String    @id @default(cuid())
  claimId           String    @unique
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  // Settlement Amounts
  totalPaid         Decimal   @db.Decimal(10, 2)
  damageAmount      Decimal?  @db.Decimal(10, 2)
  medicalAmount     Decimal?  @db.Decimal(10, 2)
  rentalAmount      Decimal?  @db.Decimal(10, 2)
  otherAmount       Decimal?  @db.Decimal(10, 2)
  deductibleApplied Decimal?  @db.Decimal(10, 2)
  
  // Payment Details
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus @default(PENDING)
  checkNumber       String?
  transactionId     String?
  paidAt            DateTime?
  
  // Documentation
  releaseObtained   Boolean   @default(false)
  releaseDate       DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([paymentStatus])
}

enum PaymentMethod {
  CHECK
  ACH
  WIRE
  DEBIT_CARD
}

enum PaymentStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// AGENT SYSTEM LOGS
// ============================================

model AgentLog {
  id                String    @id @default(cuid())
  claimId           String
  claim             Claim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  agentName         String    // e.g., "DataParser", "FraudDetector"
  agentGroup        String    // e.g., "GROUP_A", "GROUP_C"
  phase             String    // e.g., "INTAKE", "FRAUD_DETECTION"
  
  action            String
  input             Json?
  output            Json?
  confidence        Float?
  
  status            AgentStatus @default(SUCCESS)
  errorMessage      String?   @db.Text
  
  executionTimeMs   Int?
  
  createdAt         DateTime  @default(now())
  
  @@index([claimId, agentName])
  @@index([phase, status])
}

enum AgentStatus {
  SUCCESS
  FAILURE
  SKIPPED
  ESCALATED
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id                String    @id @default(cuid())
  
  // Entity References
  entityType        String    // "Claim", "Policy", "User"
  entityId          String
  claimId           String?
  claim             Claim?    @relation(fields: [claimId], references: [id], onDelete: SetNull)
  
  // Actor
  userId            String?
  user              User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  actorType         String    // "USER", "SYSTEM", "AGENT"
  
  // Action
  action            String    // "CREATE", "UPDATE", "DELETE", "APPROVE"
  description       String    @db.Text
  
  // Changes
  beforeState       Json?
  afterState        Json?
  
  // Context
  ipAddress         String?
  userAgent         String?
  metadata          Json?
  
  timestamp         DateTime  @default(now())
  
  @@index([entityType, entityId])
  @@index([claimId])
  @@index([userId])
  @@index([timestamp])
}

// ============================================
// KNOWLEDGE BASE & HANDBOOKS
// ============================================

model Handbook {
  id                String    @id @default(cuid())
  carrierId         String
  carrier           Carrier   @relation(fields: [carrierId], references: [id])
  
  title             String
  type              HandbookType
  version           String
  effectiveDate     DateTime
  
  content           String    @db.Text
  sections          Json      // Table of contents
  
  // RAG Indexing
  indexed           Boolean   @default(false)
  vectorEmbeddings  Json?     // Store embeddings for RAG
  
  isActive          Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([carrierId, type, isActive])
}

enum HandbookType {
  CLAIMS_MANUAL
  SIU_PLAYBOOK
  CORRESPONDENCE_GUIDE
  UNDERWRITING_GUIDELINES
  STATE_SPECIFIC
  TRAINING_MATERIAL
}

// ============================================
// STATE REGULATIONS
// ============================================

model StateRegulation {
  id                String    @id @default(cuid())
  state             String    @unique @db.VarChar(2)
  
  // Total Loss
  totalLossThreshold Float    // e.g., 0.75 for 75%
  totalLossFormula  String    // "ACV", "REPLACEMENT_COST"
  
  // Diminished Value
  allowsDV          Boolean   @default(false)
  dvLimitations     String?   @db.Text
  
  // Timing Requirements
  acknowledgmentDays Int       // Days to acknowledge claim
  investigationDays Int       // Days to complete investigation
  paymentDays       Int       // Days to issue payment
  
  // Compliance
  requiresROR       Boolean   @default(false) // Reservation of Rights
  specialNotices    Json?
  
  // Contact Info
  doiWebsite        String?
  doiPhone          String?
  
  updatedAt         DateTime  @updatedAt
  
  @@index([state])
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model ClaimMetrics {
  id                String    @id @default(cuid())
  carrierId         String
  
  // Time Period
  periodStart       DateTime
  periodEnd         DateTime
  
  // Volume
  totalClaims       Int
  newClaims         Int
  closedClaims      Int
  
  // Financials
  totalIncurred     Decimal   @db.Decimal(15, 2)
  totalPaid         Decimal   @db.Decimal(15, 2)
  averageClaimCost  Decimal   @db.Decimal(10, 2)
  
  // Automation
  autoApprovedCount Int
  autoApprovalRate  Float
  avgCycleTimeHours Float
  
  // Fraud
  fraudFlagsCount   Int
  fraudConfirmedCount Int
  fraudSavings      Decimal?  @db.Decimal(10, 2)
  
  // Quality
  errorRate         Float
  customerSatScore  Float?
  
  createdAt         DateTime  @default(now())
  
  @@index([carrierId, periodStart])
}